# 12.04.2024

# my idea is to visualize the following 
# chromosomes of Kyuss, the reference
# distribution of gaps, 
# distribution of snps phased by Hi-C,
# compare phase generated by PhaseGrass with Kyuss phase
# the chromosome-level phase blocks with SNP density
# the small phase blocks with SNP density


setwd("P:/Yutangchen/DH647/DH647_nextpolish/plot_phase")

# import packages
library(stringr)
library(ggplot2)
library(ggnewscale)
# library(ggh4x)

# import data
# phase generated by PhaseGrass pipeline with short reads, long reads, Hi-C
wgs_short_phase <- read.table('phase_check.txt', header = T, stringsAsFactors = F, sep = '\t')
# phase comparison between DH647 haplotypes and Kyuss by WGA
wga_phase <- read.table('SNPs_hap_vs_kyuss_nucmer.txt', header = T, stringsAsFactors = F, sep = '\t')
# Hi-C phased SNPs, generated by hapcut2, only the largest phase block
hic_phased_snp <- read.table('HiC_phased_SNP.txt', header = T, stringsAsFactors = F, sep = '\t')
# DH647 largest blocks
DH647_large <- read.table('DH647_largest_blocks.txt', header = T, stringsAsFactors = F, sep = '\t')
# DH647 small blocks
DH647_small <- read.table('DH647_small_blocks.txt', header = T, stringsAsFactors = F, sep = '\t')
# chromosome length of Kyuss v2.0
kyuss_fai <- read.table('kyuss.nextdenovo.juicer.fasta.chr.fa.fai', header = F, stringsAsFactors = F)
# gaps in chromosomes of Kyuss v2.0
kyuss_gap <- read.table('kyuss_v2.telo.label.txt', header = T, stringsAsFactors = F)

# get gap
kyuss_gap <- kyuss_gap[kyuss_gap$Type == 'gap', c(3:5)]
colnames(kyuss_gap) <- c('chr', 'start', 'end')
kyuss_gap$chr <- sub('^', 'Chr', kyuss_gap$chr)

# make the chr capital in fai
kyuss_fai <- kyuss_fai[, c(1:2)]
colnames(kyuss_fai) <- c('chr', 'length')
kyuss_fai$chr <- str_to_title(kyuss_fai$chr)

# get wga_phase_h1 and wga_phase_h2
wga_phase_h1 <- wga_phase[wga_phase$hap == 'H1', ]
colnames(wga_phase_h1)[5] <- 'snp_number'

wga_phase_h2 <- wga_phase[wga_phase$hap == 'H2', ]
colnames(wga_phase_h2)[5] <- 'snp_number'
##############################################################################################################################
# visualize the data
ggplot(data = kyuss_fai, aes(x = length, y = length)) +
  
  # determine x and y scale
  scale_x_continuous(limits = c(0, 410), expand = c(0.01, 0.01)) +
  scale_y_continuous(breaks = c(1, 2.5, 4, 5.5, 7, 8.5, 10),
                     limits = c(0, 11),
                     # labels = c('Pseudo-chromosome',
                     #            'Hi-C phased SNPs',
                     #            'Chromosome-level phase block',
                     #            'Small phase blocks',
                     #            'DipGrass haplotype vs Kyuss',
                     #            'Final haplotype 1 vs Kyuss',
                     #            'Final haplotype 2 vs Kyuss')
                     labels = c('1', '2', '3', '4', '5', '6', '7')) +
  
  # plot all chromosomes in one rwo, each column represents one chr
  # facet_grid(cols = vars(chr), scales = 'free') +
  facet_grid(rows = vars(chr), scales = 'free') +
  
  # first visualize chromosomes using rectangles
  geom_rect(data = kyuss_fai, aes(xmin = 0, ymin = 0.5, xmax = length/10^6, ymax = 1.5), fill = 'gray80', color = 'black', inherit.aes = F) + 
  
  # now add gaps to chromosomes as rectangles
  geom_rect(data = kyuss_gap, aes(xmin = start/10^6, ymin = 0.5, xmax = end/10^6, ymax = 1.5), fill = 'black', color = 'black', inherit.aes = F) +
  
  # now hic snp density through chromosomes
  geom_rect(data = hic_phased_snp, aes(xmin = start/10^6, ymin = 2, xmax = end/10^6, ymax = 3, fill = snp_number), inherit.aes = F) + 
  scale_fill_gradient(low = 'white', high = 'orange', name = '# of SNPs per 1 Mb') + 
  
  # new scale color
  new_scale_fill() +
  
  # now the largest phase block 
  geom_rect(data = DH647_large, aes(xmin = start/10^6, ymin = 3.5, xmax = end/10^6, ymax = 4.5, fill = nsnp), inherit.aes = F) +
  scale_fill_gradient(low = 'white', high = 'red', name = '# of SNPs per 1 Mb') + 
  
  # new scale color
  new_scale_fill() +
  
  # now the small phase blocks
  geom_point(data = DH647_small, aes(x = block/10^6, y = 5.5, fill = variants), size = 2, color = 'black', shape = 21, position = position_jitter(width = 0.3, height = 0.3)) +
  scale_fill_gradient(low = 'white', high = 'blue', name = '# of SNPs in small blocks') +
  
  # new scale color
  new_scale_fill() +
  
  # now wgs phase
  geom_rect(data = wgs_short_phase, aes(xmin = start/10^6, ymin = 6.5, xmax = end/10^6, ymax = 7.5, fill = switch_count*100), inherit.aes = F) +
  scale_fill_gradient2(low = "blue", mid = 'gray', high = "red", midpoint = 50, name = '% of non-Kyuss allele per 1 Mb') +
  
  # new scale color
  new_scale_fill() +
  
  # now wga phase compare
  geom_rect(data = wga_phase_h1, aes(xmin = start/10^6, ymin = 8, xmax = end/10^6, ymax = 9, fill = snp_number), inherit.aes = F) +
  scale_fill_gradient(low = 'white', high = 'darkgreen') +
  
  # now wga phase compare
  geom_rect(data = wga_phase_h2, aes(xmin = start/10^6, ymin = 9.5, xmax = end/10^6, ymax = 10.5, fill = snp_number), inherit.aes = F) +
  scale_fill_gradient(low = 'white', high = 'darkgreen', name = '# of SNPs per 1 Mb') +
  
  # axis lables
  xlab('Base pair position in Kyuss psuedo-chromosomes (Mb)') +
  ylab('') +
  
  
  # theme
  theme(strip.text.y = element_text(face = "plain", size = 15),
        # strip.background = element_blank(),
        legend.position="bottom", 
        legend.justification.bottom = "left",
        legend.text = element_text(size=10),
        legend.title = element_text(size = 15,  hjust = 0.5),
        legend.title.position = 'top',
        legend.key = element_rect(fill = NA, colour = NA),
        legend.key.height = unit(0.3, 'cm'), 
        legend.key.width = unit(0.8, 'cm'), 
        panel.border = element_blank(),
        panel.background = element_blank(),
        # panel.background = element_rect(fill = "white", colour = "black", linewidth = 0.5, linetype = "solid"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.spacing = unit(0.8, "lines"),
        axis.title.x = element_text(color="black", size=15, face="plain"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.line.x = element_line(color = 'black'))
ggsave('DH647_phase_evaluation.pdf', device = 'pdf', width = 15, height = 12)

